# 성능 최적화

## 테스트 서버 스펙
|||
-|-
cpu|12코어(6코어 * 2)
메모리|32GB
서버|2대

## 테스트 요소
1. 인덱싱 성능
    |||
    -|-
    테스트 목적|실시간으로 들어오는 대량의 데이터를 밀리거나 누락되지 않고 처리할 수 있는 지 확인<br>현 서버 기준 최적의 shard개수, 인댁스 매핑 찾기
    통과 기준|이상(에러 등) 없이 document가 인덱싱 되는 지 테스트<br>집어넣은 데이터가 누락 없이 인덱싱 되었는 지 RDB와 비교
    테스트 계획|1. Document 생성 방법: RDB -> (Logstash) -> ES<br>2. Document 개수 : 3000개/분 * 1시간<br>3. 테스트 통과 시 측정 시간을 하루, 일주일로 늘려가며 테스트 한 후, 최종 테스트 결과 판별

1. 쿼리 속도
    |||
    -|-
    테스트 목적|현재 사용하는 RDB 대비 같은 결과를 얻는 데 어느 정도 시간이 걸리는 지 측정<br>현 서버 기준 최적의 shard개수, 인댁스 매핑 찾기
    통과 기준|RDB보다 빠른 시간
    테스트 계획|RDB의 쿼리와 같은 결과물을 얻는 ES 쿼리를 작성 후 속도를 측정해 본다.

## 성능 테스트
1. 인덱싱 성능
    * 테스트 순서
        1. mariadb -> elasticsearch 데이터 동기화
        
1. 쿼리 속도
    * 인덱싱된 데이터로 RDB와 동일한 결과를 뽑아내는 데 어느 정도의 시간이 걸리는 지 측정 

### 1. mariadb -> elasticsearch 데이터 동기화
* logstash 10개 pipeline 설정
* scheduler 1분
* pipeline 하나당 1분에 300개, 총 1분에 3000개 데이터 들어감.
* `retrying failed action with response code: 429 `에러 발생.
    * 인덱싱 최적화 필요해 보임.
#### 인덱싱 최적화
* 인덱싱 성능 측정 방법.
    * bulk insert를 하고 return 시간을 측정해 본다.
* 인덱싱 성능 튜닝 방법.
    1. _all 필드
        * 특별한 목적에 의해 ES가 생성하는 필드.
    2. static index 사용해보기.
        * text 필드가 keyword 필드로 많이 바뀔 수록 그 차이는 더 크게 날 것임.
        1. text -> keyword, log -> integer로 변경
    3. refresh_interval
        * es는 새로운 문서가 인입되었을 때 인덱싱을 하고 그 결과를 세그먼트 단위로 저장함.
        * 이 세그먼트들은 백그라운드에서 머지되어 점점 큰 세그먼트가 되어가는데, es가 이 작업을 하는 것을 refresh라고 부름.
        * 이 세그먼트 생성 주기는 default 1초. (near realtime search engine 컨셉)
        * 이 작업은 성능에 영향을 준다. 1초에서 더 늘리면 더 많은 양의 데이터를 인덱싱 할 수 있음.
    4. primary shard 개수
        * 모든 인덱싱은 primary shard에서 일어남. 따라서, primary shard의 개수에 따라 인덱싱 성능이 달라질 수 있음.
    5. 필드 개수 줄이기
        * insp_type_value 부분을 object => array 형식으로 변경하여 필드 개수 줄임.(약 1000개 정도?)
        * `mapping_nested_nested_0812.json`
##### 테스트
* document count : 10000

1|2|3|4|시간
:-|:-|:-:|:-|:-
-|-|-|-|2699
_all 필드 disable|text -> keyword<br>log -> integer|-|shard 4개|2514
_all 필드 disable|text -> keyword<br>log -> integer|-|shard 12개|5100
_all 필드 disable|text -> keyword<br>log -> integer|-|shard 6개|2628

1. shard 별
    * indexing 시간(기존)

        -|2 s, 1 r|4 s, 1 r|6 s, 1 r|8 s, 1 r|10 s, 1 r|12 s, 1 r
        -|-|-|-|-|-|-
        5000개|2234<br>2190|1398<br>1506|2080<br>2760|3059<br>11176|6968<br>8332|8294<br>14363
        10000개|4236<br>4153|4776<br>2539|6479<br>8874|7312<br>6790|13072<br>11108|14600<br>17498
    => 4shard 1 replica가 가장 우수함.
2. mapping 변경(1000개 정도 줄임.)
    * indexing 시간

        -|2 s, 1 r|4 s, 1 r|6 s, 1 r|8 s, 1 r|10 s, 1 r|12 s, 1 r
        -|-|-|-|-|-|-
        5000개||900<br>882||||
        10000개||1796<br>1705||||

    * 쿼리 시간
        2 s, 1 r|4 s, 1 r|6 s, 1 r|8 s, 1 r|10 s, 1 r|12 s, 1 r
        -|-|-|-|-|-
        ||||||838
## 인덱싱 성능 향상으 위한 튜닝
1. _all 필드
    * 특별한 목적에 의해 ES가 생성하는 필드.
    * 


## alias 설정